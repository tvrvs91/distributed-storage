package main

import (
	"flag"
	"fmt"
	"log"
	"os"
	"strings"
)

func main() {
	// –§–ª–∞–≥–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∑–ª–∞
	// port - –ø–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å —Ç–µ–∫—É—â–∏–π —É–∑–µ–ª
	port := flag.String("port", "8080", "–ü–æ—Ä—Ç –¥–ª—è HTTP —Å–µ—Ä–≤–µ—Ä–∞")
	
	// peers - –∞–¥—Ä–µ—Å–∞ –¥—Ä—É–≥–∏—Ö —É–∑–ª–æ–≤, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–º–∏
	// –ù–∞–ø—Ä–∏–º–µ—Ä: "localhost:8081,localhost:8082"
	peersStr := flag.String("peers", "", "–°–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ –¥—Ä—É–≥–∏—Ö —É–∑–ª–æ–≤ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)")
	
	// storageDir - –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ
	storageDir := flag.String("storage", "./storage", "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤")
	
	flag.Parse()

	// –ü–∞—Ä—Å–∏–º —Å–ø–∏—Å–æ–∫ —É–∑–ª–æ–≤-—Å–æ—Å–µ–¥–µ–π
	var peers []string
	if *peersStr != "" {
		peers = strings.Split(*peersStr, ",")
	}

	// –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
	if err := os.MkdirAll(*storageDir, 0755); err != nil {
		log.Fatalf("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ö—Ä–∞–Ω–µ–Ω–∏—è: %v", err)
	}

	// –°–æ–∑–¥–∞—ë–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —É–∑–µ–ª —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
	node := NewNode(*port, peers, *storageDir)
	
	fmt.Printf("üöÄ –£–∑–µ–ª –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É %s\n", *port)
	fmt.Printf("üìÅ –•—Ä–∞–Ω–∏–ª–∏—â–µ: %s\n", *storageDir)
	fmt.Printf("üîó –°–æ—Å–µ–¥–Ω–∏–µ —É–∑–ª—ã: %v\n", peers)
	
	// –ó–∞–ø—É—Å–∫–∞–µ–º HTTP —Å–µ—Ä–≤–µ—Ä
	// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø–æ—ç—Ç–æ–º—É –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–π
	if err := node.Start(); err != nil {
		log.Fatalf("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —É–∑–ª–∞: %v", err)
	}
}